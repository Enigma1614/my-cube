<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Piano | ÈúìËôπÈãºÁê¥</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; overflow: hidden; font-family: 'Arial Black', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100%; height: 100%; max-width: 600px; margin: 0 auto; background: linear-gradient(to bottom, #111 0%, #000 100%); box-shadow: 0 0 50px rgba(0,255,255,0.1); }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI Â±§ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
        
        .hud-top { width: 100%; padding: 20px 20px 0 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 10; width: 100%; }
        .score { color: #fff; font-size: 24px; text-shadow: 0 0 10px #0ff; }
        
        /* ÁîüÂëΩÂÄºÈ°ØÁ§∫ */
        .life-box { color: #ff3b30; font-size: 24px; text-shadow: 0 0 10px #ff3b30; display: flex; align-items: center; gap: 5px; }
        
        .combo-box { text-align: center; margin-top: 30px; opacity: 0; transition: opacity 0.2s; }
        .combo-num { font-size: 60px; color: #ffeb3b; -webkit-text-stroke: 2px #b2a300; display: block; line-height: 1; transform: scale(1); }
        .combo-text { font-size: 16px; color: #fff; letter-spacing: 2px; }
        
        /* ÊµÆÂãïÂà§ÂÆöÊñáÂ≠ó */
        .feedback { position: absolute; font-size: 40px; font-weight: bold; animation: popUp 0.5s ease-out forwards; text-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 20; }
        @keyframes popUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -20px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -40px) scale(1); opacity: 0; } }
        
        .perfect { color: #00ffea; }
        .good { color: #00ff00; }
        .miss { color: #ff004c; }

        /* ÈÅ∏ÂñÆËàáÁµêÁÆóÁï´Èù¢ */
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 100; backdrop-filter: blur(8px); transition: opacity 0.3s; }
        
        .title { font-size: 40px; color: #fff; margin-bottom: 30px; text-shadow: 0 0 20px #0ff; letter-spacing: 4px; text-align: center; }
        .final-score { font-size: 20px; color: #aaa; margin-bottom: 30px; display: none; }
        
        .diff-container { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; }
        
        .diff-btn { 
            padding: 15px; font-size: 20px; color: #fff; border: 2px solid; border-radius: 8px; cursor: pointer; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; background: transparent; transition: all 0.2s;
        }
        
        .diff-btn:hover { transform: scale(1.05); }
        .diff-btn:active { transform: scale(0.95); }

        .btn-easy { border-color: #4cd964; color: #4cd964; box-shadow: 0 0 10px #4cd964; }
        .btn-easy:hover { background: #4cd964; color: #000; }

        .btn-normal { border-color: #ffd700; color: #ffd700; box-shadow: 0 0 10px #ffd700; }
        .btn-normal:hover { background: #ffd700; color: #000; }

        .btn-hard { border-color: #ff3b30; color: #ff3b30; box-shadow: 0 0 10px #ff3b30; }
        .btn-hard:hover { background: #ff3b30; color: #fff; }

        .btn-insane { border-color: #bd00ff; color: #bd00ff; box-shadow: 0 0 15px #bd00ff; animation: pulse 1s infinite alternate; }
        .btn-insane:hover { background: #bd00ff; color: #fff; }
        
        @keyframes pulse { from { box-shadow: 0 0 10px #bd00ff; } to { box-shadow: 0 0 25px #bd00ff; } }

        /* ÂõûÈ¶ñÈ†ÅÊåâÈàï */
        .home-btn { position: absolute; top: 20px; left: 20px; color: #666; text-decoration: none; font-size: 24px; z-index: 200; pointer-events: auto; }
        
        /* ÈÅäÊà≤ÁµêÊùüÂæåÁöÑÊåâÈàï */
        #restart-container { display: none; width: 100%; flex-direction: column; align-items: center; gap: 15px;}
        .restart-btn { padding: 12px 40px; background: #fff; color: #000; border: none; font-size: 18px; cursor: pointer; border-radius: 50px; font-weight: bold;}
    </style>
</head>
<body>

<div id="game-container">
    <a href="index.html" class="home-btn" id="home-icon">üè†</a>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div class="hud-top">
            <div class="score">SCORE: <span id="score-val">0</span></div>
            <div class="life-box">‚ù§ <span id="life-val">10</span></div>
        </div>
        <div class="combo-box" id="combo-box">
            <span class="combo-num" id="combo-val">0</span>
            <span class="combo-text">COMBO</span>
        </div>
    </div>
    
    <div id="start-screen">
        <div class="title" id="screen-title">SELECT MODE</div>
        <div class="final-score" id="final-score">Score: 0</div>
        
        <div class="diff-container" id="diff-select">
            <button class="diff-btn btn-easy" onclick="startGame('EASY')">EASY</button>
            <button class="diff-btn btn-normal" onclick="startGame('NORMAL')">NORMAL</button>
            <button class="diff-btn btn-hard" onclick="startGame('HARD')">HARD</button>
            <button class="diff-btn btn-insane" onclick="startGame('INSANE')">INSANE üî•</button>
        </div>

        <div id="restart-container">
            <button class="restart-btn" onclick="resetToMenu()">MENU</button>
        </div>
    </div>
</div>

<script>
    // --- Á≥ªÁµ±ËÆäÊï∏ ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiLayer = document.getElementById('ui-layer');
    const scoreVal = document.getElementById('score-val');
    const lifeVal = document.getElementById('life-val');
    const comboBox = document.getElementById('combo-box');
    const comboVal = document.getElementById('combo-val');
    
    const startScreen = document.getElementById('start-screen');
    const screenTitle = document.getElementById('screen-title');
    const diffSelect = document.getElementById('diff-select');
    const restartContainer = document.getElementById('restart-container');
    const finalScoreEl = document.getElementById('final-score');
    const homeIcon = document.getElementById('home-icon');

    // --- ÈÅäÊà≤ÁãÄÊÖãËÆäÊï∏ ---
    let gameState = 'MENU'; // MENU, PLAYING, GAMEOVER
    let score = 0;
    let combo = 0;
    let life = 10;
    let maxLife = 10;
    let notes = [];
    let particles = [];
    let nextSpawnTime = 0;
    
    // --- ÈÖçÁΩÆÂèÉÊï∏ (ÊúÉË¢´Èõ£Â∫¶Ë¶ÜËìã) ---
    let CONFIG = {
        LANE_COUNT: 4,
        HIT_Y_RATIO: 0.85,
        COLORS: ['#ff0055', '#00ccff', '#ffcc00', '#00ffaa'],
        SPEED_BASE: 0.0015, 
        SPAWN_GAP: 800 
    };

    // Èõ£Â∫¶Êï∏ÊìöÂ∫´
    const DIFFICULTIES = {
        'EASY':   { speed: 0.0010, gap: 1000 },
        'NORMAL': { speed: 0.0015, gap: 800 },
        'HARD':   { speed: 0.0022, gap: 600 },
        'INSANE': { speed: 0.0035, gap: 350 }
    };

    let metrics = { w: 0, h: 0, laneW: 0, hitY: 0, speed: 0 };

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        metrics.w = rect.width;
        metrics.h = rect.height;
        metrics.laneW = metrics.w / CONFIG.LANE_COUNT;
        metrics.hitY = metrics.h * CONFIG.HIT_Y_RATIO;
        metrics.speed = metrics.h * CONFIG.SPEED_BASE;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- Èü≥ÊïàÁ≥ªÁµ± (Web Audio) ---
    let audioCtx;
    const FREQS = [261.63, 293.66, 329.63, 349.23]; 
    
    function initAudio() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(lane) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = FREQS[lane % 4] * (1 + Math.floor(lane/4)); 
        osc.type = 'triangle';
        const volume = 0.8; 
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- Á≤íÂ≠êÁâπÊïà ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 0.5) * 10;
            this.life = 1;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    // --- Ê†∏ÂøÉÈÇèËºØÔºöÈñãÂßãÈÅäÊà≤ ---
    function startGame(diff) {
        // Ë®≠ÂÆöÂèÉÊï∏
        const setting = DIFFICULTIES[diff];
        CONFIG.SPEED_BASE = setting.speed;
        CONFIG.SPAWN_GAP = setting.gap;
        resize(); // ÊáâÁî®Êñ∞ÈÄüÂ∫¶

        // ÈáçÁΩÆÊâÄÊúâÈÅäÊà≤ÁãÄÊÖã (ÂØ©Êü•ÈáçÈªû 3: Á¢∫‰øùÁÑ°ÊÆòÁïô)
        score = 0;
        combo = 0;
        life = maxLife;
        notes = [];
        particles = [];
        nextSpawnTime = Date.now(); // ÈóúÈçµÔºöÈáçÁΩÆÊôÇÈñìÊà≥
        gameState = 'PLAYING';

        // Êõ¥Êñ∞ UI
        scoreVal.innerText = score;
        lifeVal.innerText = life;
        startScreen.style.opacity = 0;
        setTimeout(() => startScreen.style.display = 'none', 300);
        homeIcon.style.display = 'none'; // ÈÅäÊà≤‰∏≠Èö±Ëóè Home ÈçµÈò≤Ë™§Ëß∏

        initAudio();
        loop();
    }

    // --- Ê†∏ÂøÉÈÇèËºØÔºöÁîüÊàêÈü≥Á¨¶ ---
    function spawnNoteLogic(currentTime) {
        if (currentTime > nextSpawnTime) {
            const lane = Math.floor(Math.random() * 4);
            const speedUp = Math.min(200, combo * 5); 
            const currentGap = Math.max(200, CONFIG.SPAWN_GAP - speedUp);
            
            notes.push({
                lane: lane,
                spawnTime: currentTime,
                y: -100, 
                hit: false,
                missed: false,
                color: CONFIG.COLORS[lane]
            });
            nextSpawnTime = currentTime + currentGap;
        }
    }

    // --- Ê†∏ÂøÉÈÇèËºØÔºöÁâ©ÁêÜËàá Miss Âà§ÂÆö ---
    function updatePhysics() {
        notes.forEach(n => {
            if(n.hit || n.missed) return;
            n.y += metrics.speed * 16;
            
            // ÂØ©Êü•ÈáçÈªû 2: Miss ÈÇèËºØ‰øÆÊ≠£
            if (n.y > metrics.h) {
                n.missed = true;
                handleMiss(n.lane);
            }
        });
        
        notes = notes.filter(n => !n.missed && !n.hit);
        particles = particles.filter(p => p.life > 0);
    }

    function handleMiss(lane) {
        combo = 0;
        updateComboUI();
        life--; // Êâ£Ë°Ä
        lifeVal.innerText = life;
        
        const x = lane * metrics.laneW + metrics.laneW/2;
        showFeedback(x, metrics.h - 50, 'MISS', 'miss');

        if (life <= 0) {
            triggerGameOver();
        }
    }

    function triggerGameOver() {
        gameState = 'GAMEOVER';
        screenTitle.innerText = "GAME OVER";
        screenTitle.style.color = "#ff3b30";
        screenTitle.style.textShadow = "0 0 20px #ff3b30";
        
        diffSelect.style.display = 'none';
        restartContainer.style.display = 'flex';
        finalScoreEl.style.display = 'block';
        finalScoreEl.innerText = `Final Score: ${score}`;
        
        startScreen.style.display = 'flex';
        setTimeout(() => startScreen.style.opacity = 1, 10);
        homeIcon.style.display = 'block';
    }

    function resetToMenu() {
        screenTitle.innerText = "SELECT MODE";
        screenTitle.style.color = "#fff";
        screenTitle.style.textShadow = "0 0 20px #0ff";
        
        diffSelect.style.display = 'flex';
        restartContainer.style.display = 'none';
        finalScoreEl.style.display = 'none';
        gameState = 'MENU';
    }

    // --- Ê†∏ÂøÉÈÇèËºØÔºöÈªûÊìäÂà§ÂÆö (Hit Detection) ---
    function checkHit(lane) {
        if(gameState !== 'PLAYING') return;

        initAudio();
        playSound(lane); 
        
        // ÂØ©Êü•ÈáçÈªû 1: Âà§ÂÆöÁ™óÂè£
        // Â∞ãÊâæË©≤ËªåÈÅì‰∏ä„ÄåÊú™Ë¢´Êìä‰∏≠„Äç‰∏î„ÄåÂú®Âà§ÂÆöÁØÑÂúçÂÖß„ÄçÁöÑÁ¨¨‰∏ÄÂÄãÈü≥Á¨¶
        const target = notes.find(n => n.lane === lane && !n.hit && Math.abs(n.y - metrics.hitY) < 150);
        const x = lane * metrics.laneW + metrics.laneW/2;
        
        if (target) {
            const dist = Math.abs(target.y - metrics.hitY);
            
            // Á´ãÂç≥Ê®ôË®òÔºåÈò≤Ê≠¢ÈáçË§áË®àÂàÜ
            target.hit = true; 
            
            if (dist < 40) { 
                score += 100;
                combo++;
                showFeedback(x, metrics.hitY, 'PERFECT', 'perfect');
                createExplosion(x, metrics.hitY, target.color);
            } else { 
                score += 50;
                combo++;
                showFeedback(x, metrics.hitY, 'GOOD', 'good');
                createExplosion(x, metrics.hitY, '#fff');
            }
        }
        // Á©∫ÊèÆ‰∏çÊâ£ÂàÜ (Ë®≠Ë®àÈÅ∏Êìá)Ôºå‰ΩÜ‰Ω†ÂèØ‰ª•Âú®ÈÄôË£°Âä†ÂÖ•Êâ£ÂàÜÈÇèËºØ
        
        updateComboUI();
        scoreVal.innerText = score;
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<8; i++) particles.push(new Particle(x, y, color));
    }

    function showFeedback(x, y, text, type) {
        const el = document.createElement('div');
        el.className = `feedback ${type}`;
        el.innerText = text;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        uiLayer.appendChild(el);
        setTimeout(() => el.remove(), 500);
    }

    function updateComboUI() {
        if(combo > 2) {
            comboBox.style.opacity = 1;
            comboVal.innerText = combo;
            comboVal.style.transform = 'scale(1.5)';
            setTimeout(() => comboVal.style.transform = 'scale(1)', 100);
        } else {
            comboBox.style.opacity = 0;
        }
    }

    // --- Ëº∏ÂÖ•Áõ£ËÅΩ ---
    const keys = ['d', 'f', 'j', 'k'];
    document.addEventListener('keydown', e => {
        if(e.repeat) return;
        const idx = keys.indexOf(e.key.toLowerCase());
        if(idx > -1) checkHit(idx);
    });

    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        for(let i=0; i<e.touches.length; i++) {
            const t = e.touches[i];
            const lane = Math.floor((t.clientX / metrics.w) * 4);
            if(lane >= 0 && lane < 4) checkHit(lane);
        }
    }, {passive: false});

    // --- ‰∏ªÂæ™Áí∞ ---
    function loop() {
        if(gameState !== 'PLAYING') return;
        
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(0, 0, metrics.w, metrics.h);

        const now = Date.now();
        spawnNoteLogic(now);
        updatePhysics();

        // Áπ™Ë£ΩËàáÊ∏≤Êüì (Ëàá‰πãÂâçÁõ∏ÂêåÔºå‰∏çÂÜçË¥ÖËø∞Ôºå‰øùÊåÅË¶ñË¶∫‰∏ÄËá¥)
        ctx.strokeStyle = '#222';
        ctx.beginPath();
        for(let i=1; i<4; i++) {
            ctx.moveTo(i*metrics.laneW, 0); ctx.lineTo(i*metrics.laneW, metrics.h);
        }
        ctx.stroke();

        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.shadowBlur = 10; ctx.shadowColor = '#fff';
        ctx.beginPath();
        ctx.moveTo(0, metrics.hitY); ctx.lineTo(metrics.w, metrics.hitY);
        ctx.stroke();
        ctx.shadowBlur = 0;

        notes.forEach(n => {
            if(n.hit) return;
            ctx.fillStyle = n.color;
            ctx.shadowBlur = 15; ctx.shadowColor = n.color;
            ctx.fillRect(n.lane * metrics.laneW + 5, n.y, metrics.laneW - 10, metrics.h * 0.15);
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillRect(n.lane * metrics.laneW + 5, n.y, metrics.laneW - 10, 10);
        });

        particles.forEach(p => { p.update(); p.draw(ctx); });

        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
