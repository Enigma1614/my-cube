<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Piano | é»æ“Šçˆ†ç ´ç‰ˆ</title>
    <style>
        /* === æ ¸å¿ƒæ¨£å¼ï¼šé–æ­»è§¸æ§ï¼Œé˜²æ­¢ç¸®æ”¾ === */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            touch-action: none; user-select: none; -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šé«˜äº® */
        }
        
        #game-container { 
            position: relative; width: 100%; height: 100%; max-width: 650px; margin: 0 auto; 
            background: linear-gradient(to bottom, #0a001a 0%, #000 100%); /* æ›´æ·±é‚ƒçš„èƒŒæ™¯ */
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.1); 
            transition: transform 0.05s;
            cursor: crosshair; /* æ»‘é¼ è®Šåå­—æº–å¿ƒæ›´æœ‰å°„æ“Šæ„Ÿ */
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* === ç€•æ­»ç´…æ¡†è­¦å‘Šç‰¹æ•ˆ === */
        #danger-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 100px rgba(255, 0, 0, 0);
            pointer-events: none; z-index: 5;
            transition: box-shadow 0.3s;
        }
        .danger-active { animation: dangerPulse 0.8s infinite; }
        @keyframes dangerPulse { 
            0%, 100% { box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.3); } 
            50% { box-shadow: inset 0 0 150px rgba(255, 0, 0, 0.8); } 
        }
        
        /* === UI å±¤ === */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .hud { 
            width: 100%; padding: 60px 20px 10px 20px; 
            display: flex; justify-content: space-between; align-items: flex-end; 
            box-sizing: border-box; z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }

        .life-group { text-align: left; }
        .life-bar { display: flex; gap: 2px; height: 10px; margin-top: 5px; }
        .life-pip { width: 15px; height: 8px; background: #333; border-radius: 2px; transition: background 0.2s; }
        .life-pip.active { background: #ff3b30; box-shadow: 0 0 10px #ff3b30; }
        
        .score-group { text-align: right; }
        .score-val { font-size: 36px; color: #fff; font-weight: 900; text-shadow: 0 0 15px #00e5ff; font-family: monospace; line-height: 1; }
        .score-label { font-size: 10px; color: #888; letter-spacing: 2px; text-transform: uppercase; }

        /* Combo ç‰¹æ•ˆ */
        .combo-container { 
            position: absolute; top: 20%; width: 100%; text-align: center; 
            opacity: 0; transition: opacity 0.1s; transform: scale(0.8);
            pointer-events: none;
        }
        .combo-num { font-size: 80px; font-weight: 900; color: #fff; -webkit-text-stroke: 2px #ffd700; font-style: italic; line-height: 0.8; text-shadow: 5px 5px 0px rgba(0,0,0,0.5); }
        .combo-text { font-size: 20px; color: #ffd700; letter-spacing: 5px; font-weight: bold; }
        
        /* åˆ¤å®šæ–‡å­— - æ–°ç‰ˆçµ±ä¸€ç‚ºé‡‘è‰² HIT */
        .feedback { 
            position: absolute; font-size: 40px; font-weight: 900; z-index: 20; 
            white-space: nowrap; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            animation: popAndFade 0.4s ease-out forwards;
            color: #ffd700; -webkit-text-stroke: 1px #fff;
        }
        @keyframes popAndFade { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.0); opacity: 0; }
        }
        .miss { color: #ff3b30; font-size: 50px; -webkit-text-stroke: 0; }

        /* === æŒ‰éˆ•èˆ‡é¸å–® === */
        .home-btn {
            position: absolute; top: 15px; left: 15px; pointer-events: auto; z-index: 200;
            text-decoration: none; font-size: 24px; color: #fff;
            width: 44px; height: 44px; background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); transition: transform 0.1s;
        }
        .home-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }

        #start-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(5, 5, 10, 0.95); backdrop-filter: blur(15px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 100; transition: opacity 0.3s;
        }
        
        .logo { font-size: 42px; color: #fff; font-weight: 900; letter-spacing: -2px; text-shadow: 0 0 20px #00e5ff; margin-bottom: 5px; font-style: italic; }
        .tagline { color: #ffd700; font-size: 16px; margin-bottom: 40px; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }

        .diff-btn {
            width: 260px; padding: 18px; margin: 8px 0;
            background: transparent; border: 2px solid #333; border-radius: 12px;
            color: #fff; font-size: 18px; font-weight: bold; letter-spacing: 1px;
            cursor: pointer; position: relative; overflow: hidden; transition: 0.2s;
            text-transform: uppercase; display: flex; justify-content: space-between; align-items: center;
        }
        .diff-btn span { pointer-events: none; }
        .diff-btn .dots { font-size: 12px; opacity: 0.5; }
        .diff-btn:active { transform: scale(0.95); }
        
        .d-easy { border-color: #00ff66; color: #00ff66; }
        .d-normal { border-color: #00e5ff; color: #00e5ff; }
        .d-hard { border-color: #ffcc00; color: #ffcc00; }
        .d-insane { border-color: #ff0055; color: #ff0055; animation: pulseBorder 0.8s infinite alternate; }
        @keyframes pulseBorder { from { box-shadow: 0 0 5px #ff0055; } to { box-shadow: 0 0 25px #ff0055; } }

        /* Game Over UI */
        #game-over-ui { display: none; flex-direction: column; align-items: center; width: 100%; }
        .final-score { font-size: 70px; font-weight: 900; color: #fff; margin: 10px 0 30px 0; text-shadow: 0 0 30px rgba(255,255,255,0.5); }
        .menu-btn { padding: 15px 40px; background: #fff; color: #000; border: none; font-size: 20px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px #fff; }

    </style>
</head>
<body>

<a href="index.html" class="home-btn">ğŸ </a>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="danger-overlay"></div>

    <div id="ui-layer">
        <div class="hud">
            <div class="life-group">
                <div style="font-size: 12px; color: #888; font-weight: bold;">ENERGY</div>
                <div class="life-bar" id="life-container"></div>
            </div>
            <div class="score-group">
                <div class="score-label">SCORE</div>
                <div class="score-val" id="score-val">0</div>
            </div>
        </div>

        <div class="combo-container" id="combo-box">
            <div class="combo-num" id="combo-val">0</div>
            <div class="combo-text">COMBO</div>
        </div>
    </div>

    <div id="start-screen">
        <div id="main-menu" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            <div class="logo">NEON PIANO</div>
            <div class="tagline">TAP THE BLOCKS EDITION</div>
            
            <button class="diff-btn d-easy" onclick="startGame('EASY')">
                <span>EASY</span> <span class="dots">â—</span>
            </button>
            <button class="diff-btn d-normal" onclick="startGame('NORMAL')">
                <span>NORMAL</span> <span class="dots">â—â—</span>
            </button>
            <button class="diff-btn d-hard" onclick="startGame('HARD')">
                <span>HARD</span> <span class="dots">â—â—â—</span>
            </button>
            <button class="diff-btn d-insane" onclick="startGame('INSANE')">
                <span>INSANE</span> <span class="dots">â˜ ï¸â˜ ï¸â˜ ï¸</span>
            </button>
        </div>

        <div id="game-over-ui">
            <div style="color: #ff3b30; font-size: 30px; font-weight: 900; letter-spacing: 5px;">GAME OVER</div>
            <div class="final-score" id="final-score">0</div>
            <button class="menu-btn" onclick="resetToMenu()">MAIN MENU</button>
        </div>
    </div>
</div>

<script>
    /** ================= ç³»çµ±è¨­ç½® ================= **/
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gameContainer = document.getElementById('game-container');
    const dangerOverlay = document.getElementById('danger-overlay');
    
    const uiLayer = document.getElementById('ui-layer');
    const scoreValEl = document.getElementById('score-val');
    const lifeContainer = document.getElementById('life-container');
    const comboBox = document.getElementById('combo-box');
    const comboValEl = document.getElementById('combo-val');
    
    const startScreen = document.getElementById('start-screen');
    const mainMenu = document.getElementById('main-menu');
    const gameOverUi = document.getElementById('game-over-ui');
    const finalScoreEl = document.getElementById('final-score');

    let gameState = 'MENU';
    let score = 0;
    let combo = 0;
    let life = 10;
    const MAX_LIFE = 10;
    
    let notes = [];
    let particles = [];
    let nextSpawnTime = 0;

    // ç²’å­é¡åˆ¥
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 15; // çˆ†ç‚¸ç¯„åœæ›´å¤§
            this.vy = (Math.random() - 0.5) * 15;
            this.life = 1.0;
            this.size = Math.random() * 6 + 4;
            this.decay = Math.random() * 0.03 + 0.02;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += 0.3; // è¼•å¾®é‡åŠ›
            this.life -= this.decay;
        }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath(); 
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); 
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    /** ================= é›£åº¦é…ç½® (é‡å°æ–°ç©æ³•é‡æ–°å¹³è¡¡) ================= **/
    const CONFIG = {
        LANE_COUNT: 4,
        COLORS: ['#ff0055', '#00e5ff', '#ffcc00', '#00ff66'], 
        BASE_SPEED: 0.001
    };

    // å¯©æŸ¥é‡é» 4ï¼šå› ç‚ºè®Šç°¡å–®äº†ï¼Œæ‰€ä»¥é€Ÿåº¦å’Œå¯†åº¦éƒ½è¦å¤§å¹…æå‡
    const DIFFICULTIES = {
        'EASY':   { speedMod: 1.5, gap: 450,  multiChance: 0.0 }, 
        'NORMAL': { speedMod: 2.2, gap: 350,  multiChance: 0.2 }, 
        'HARD':   { speedMod: 3.0, gap: 250,  multiChance: 0.4 }, 
        'INSANE': { speedMod: 4.5, gap: 150,  multiChance: 0.6 } // å½ˆå¹•åœ°ç„
    };

    let currentDiffSetting = DIFFICULTIES['NORMAL'];
    let metrics = { w: 0, h: 0, laneW: 0, noteH: 0, speed: 0 };

    /** ================= æ ¸å¿ƒèˆ‡æ¸²æŸ“ ================= **/
    function resize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        
        metrics.w = rect.width;
        metrics.h = rect.height;
        metrics.laneW = metrics.w / CONFIG.LANE_COUNT;
        metrics.noteH = metrics.h * 0.12; // æ–¹å¡Šé«˜åº¦
        
        if (gameState === 'PLAYING') {
            metrics.speed = metrics.h * CONFIG.BASE_SPEED * currentDiffSetting.speedMod;
        }
    }
    window.addEventListener('resize', resize);
    resize();

    function renderLifeBar() {
        lifeContainer.innerHTML = '';
        for(let i=0; i<MAX_LIFE; i++) {
            const pip = document.createElement('div');
            pip.className = `life-pip ${i < life ? 'active' : ''}`;
            lifeContainer.appendChild(pip);
        }
        if (life <= 3 && life > 0) {
            dangerOverlay.classList.add('danger-active');
        } else {
            dangerOverlay.classList.remove('danger-active');
        }
    }

    /** ================= éŸ³æ•ˆç³»çµ± (MAX Volume) ================= **/
    let audioCtx;
    // ä½¿ç”¨æ›´æ¸…è„†çš„åˆæˆéŸ³
    const FREQS = [523.25, 622.25, 783.99, 932.33]; // C5, Eb5, G5, Bb5
    
    function initAudio() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(lane) {
        if(!audioCtx) return;
        
        const osc = audioCtx.createOscillator();
        osc.type = 'square'; // æ–¹æ³¢æ›´æœ‰æ‰“æ“Šæ„Ÿ
        osc.frequency.setValueAtTime(FREQS[lane % 4], audioCtx.currentTime);

        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); // çŸ­ä¿ƒæœ‰åŠ›

        // é«˜é€šæ¿¾æ³¢å™¨å¢åŠ æ¸…è„†æ„Ÿ
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 1000;

        osc.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
    }

    /** ================= éŠæˆ²é‚è¼¯ ================= **/
    function startGame(diff) {
        currentDiffSetting = DIFFICULTIES[diff];
        metrics.speed = metrics.h * CONFIG.BASE_SPEED * currentDiffSetting.speedMod;
        score = 0;
        combo = 0;
        life = MAX_LIFE;
        notes = [];
        particles = [];
        nextSpawnTime = Date.now();
        gameState = 'PLAYING';
        scoreValEl.innerText = '0';
        renderLifeBar();
        startScreen.style.opacity = 0;
        setTimeout(() => startScreen.style.display = 'none', 300);
        initAudio();
        loop();
    }

    function spawnLogic(now) {
        if (now > nextSpawnTime) {
            let gap = currentDiffSetting.gap;
            gap *= (1 - Math.min(combo * 0.001, 0.15)); // Combo åŠ é€Ÿä¸Šé™é™ä½
            const lane1 = Math.floor(Math.random() * 4);
            createNote(lane1, now);
            
            // å¤šæŠ¼ç”Ÿæˆ
            if (Math.random() < currentDiffSetting.multiChance) {
                let lane2 = (lane1 + 1 + Math.floor(Math.random() * 3)) % 4;
                createNote(lane2, now);
                if (currentDiffSetting.multiChance > 0.4 && Math.random() < 0.4) {
                     let lane3 = (lane1 + 2) % 4;
                     if (lane3 !== lane2) createNote(lane3, now);
                }
            }
            nextSpawnTime = now + gap;
        }
    }

    function createNote(lane, time) {
        notes.push({
            lane: lane,
            // å¯©æŸ¥é‡é» 5: ç¢ºä¿ç”Ÿæˆæ™‚åœ¨ç•«é¢å¤–
            y: -metrics.noteH * 1.5, 
            color: CONFIG.COLORS[lane],
            hit: false,
            missed: false
        });
    }

    function updatePhysics() {
        notes.forEach(n => {
            if (n.hit || n.missed) return;
            n.y += metrics.speed * 16; 
            // Miss åˆ¤å®šï¼šå®Œå…¨é›¢é–‹è¢å¹•åº•éƒ¨
            if (n.y > metrics.h) {
                n.missed = true;
                handleMiss(n.lane);
            }
        });
        notes = notes.filter(n => !n.hit && !n.missed);
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
    }

    function handleMiss(lane) {
        life--;
        combo = 0;
        renderLifeBar();
        updateComboUI();
        gameContainer.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
        setTimeout(() => gameContainer.style.transform = 'none', 50);
        // Miss æ–‡å­—é¡¯ç¤ºåœ¨åº•éƒ¨è»Œé“
        showFeedback(lane * metrics.laneW + metrics.laneW/2, metrics.h - 50, 'MISS', 'miss');
        if (life <= 0) gameOver();
    }

    // â˜…â˜…â˜… æ–°ç‰ˆæ ¸å¿ƒï¼šè§¸æ§ç¢°æ’åµæ¸¬ â˜…â˜…â˜…
    function checkCollision(touchX, touchY) {
        if (gameState !== 'PLAYING') return;
        
        let hitOccurred = false;
        
        // å¯©æŸ¥é‡é» 2: å¢åŠ æ‰‹æŒ‡è§¸æ§å®¹éŒ¯åŠå¾‘
        const fingerRadius = 25; 

        // å€’åºéæ­·ï¼Œå„ªå…ˆåˆ¤å®šæœ€ä¸Šé¢çš„åœ–å±¤ï¼ˆé›–ç„¶é€™è£¡æ²’å·®ï¼Œä½†å¥½ç¿’æ…£ï¼‰
        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            if (n.hit || n.missed) continue;

            // æ–¹å¡Šçš„é‚Šç•Œ
            const boxX = n.lane * metrics.laneW;
            const boxY = n.y;
            const boxW = metrics.laneW;
            const boxH = metrics.noteH;

            // ç°¡å–®çš„åœ“å½¢èˆ‡çŸ©å½¢ç¢°æ’æª¢æ¸¬
            let testX = touchX;
            let testY = touchY;
            
            if (touchX < boxX) testX = boxX;
            else if (touchX > boxX + boxW) testX = boxX + boxW;
            
            if (touchY < boxY) testY = boxY;
            else if (touchY > boxY + boxH) testY = boxY + boxH;

            const distX = touchX - testX;
            const distY = touchY - testY;
            const distance = Math.sqrt((distX * distX) + (distY * distY));

            if (distance <= fingerRadius) {
                // æ“Šä¸­ï¼
                n.hit = true;
                hitOccurred = true;
                handleHit(n, touchX, touchY);
                // é‡è¦ï¼šä¸€å€‹è§¸æ§é»åªæ¶ˆé™¤ä¸€å€‹æ–¹å¡Šï¼Œé¿å…ä¸€æŒ‡å¤šæ¶ˆ
                break; 
            }
        }
    }

    function handleHit(note, hitX, hitY) {
        score += 100;
        combo++;
        playSound(note.lane);
        
        // å¯©æŸ¥é‡é» 3: ç‰¹æ•ˆåœ¨æ“Šä¸­é»çˆ†ç™¼
        showFeedback(hitX, hitY, 'HIT!', 'perfect');
        spawnParticles(hitX, hitY, note.color, 20);
        
        scoreValEl.innerText = score;
        updateComboUI();
    }

    function spawnParticles(x, y, color, count) {
        for(let i=0; i<count; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    function showFeedback(x, y, text, type) {
        const el = document.createElement('div');
        el.className = `feedback ${type}`;
        el.innerText = text;
        // è®“æ–‡å­—ä¸è¦è·‘å‡ºè¢å¹•é‚Šç•Œ
        const safeX = Math.max(50, Math.min(metrics.w - 50, x));
        const safeY = Math.max(50, Math.min(metrics.h - 50, y));
        el.style.left = safeX + 'px';
        el.style.top = safeY + 'px';
        uiLayer.appendChild(el);
        setTimeout(() => el.remove(), 400);
    }

    function updateComboUI() {
        if (combo > 5) {
            comboBox.style.opacity = 1;
            comboBox.style.transform = 'scale(1.2)';
            comboValEl.innerText = combo;
            setTimeout(() => comboBox.style.transform = 'scale(1)', 100);
        } else {
            comboBox.style.opacity = 0;
            comboBox.style.transform = 'scale(0.8)';
        }
    }

    function gameOver() {
        gameState = 'GAMEOVER';
        finalScoreEl.innerText = score;
        startScreen.style.display = 'flex';
        mainMenu.style.display = 'none';
        gameOverUi.style.display = 'flex';
        setTimeout(() => startScreen.style.opacity = 1, 10);
        dangerOverlay.classList.remove('danger-active');
    }

    function resetToMenu() {
        mainMenu.style.display = 'flex';
        gameOverUi.style.display = 'none';
        gameState = 'MENU';
    }

    // --- è¼¸å…¥ç›£è½ (å…¨é¢æ”¹ç‚ºè§¸æ§/æ»‘é¼ ) ---
    
    // è™•ç†è§¸æ§èˆ‡æ»‘é¼ çš„é€šç”¨å‡½å¼
    function handleInputStart(e) {
        if (gameState !== 'PLAYING') return;
        // e.preventDefault(); // è¦–æƒ…æ³é–‹å•Ÿï¼Œå¯èƒ½æœƒæ“‹ä½æ»‘é¼ äº‹ä»¶

        const rect = canvas.getBoundingClientRect();
        
        // æ”¯æ´å¤šé»è§¸æ§
        if (e.touches) {
            for (let i = 0; i < e.touches.length; i++) {
                const x = e.touches[i].clientX - rect.left;
                const y = e.touches[i].clientY - rect.top;
                checkCollision(x, y);
            }
        } 
        // æ”¯æ´æ»‘é¼ å–®é»
        else {
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            checkCollision(x, y);
        }
    }

    // ç›£è½ Canvas ä¸Šçš„æ“ä½œ
    canvas.addEventListener('touchstart', handleInputStart, { passive: false });
    canvas.addEventListener('mousedown', handleInputStart);

    /** ================= éŠæˆ²å¾ªç’° ================= **/
    function loop() {
        if (gameState !== 'PLAYING') return;

        ctx.clearRect(0, 0, metrics.w, metrics.h);
        const now = Date.now();
        spawnLogic(now);
        updatePhysics();

        // ç¹ªè£½èƒŒæ™¯å…‰æšˆ (ç¨å¾®å¼±åŒ–ï¼Œå‡¸é¡¯æ–¹å¡Š)
        ctx.globalCompositeOperation = 'lighter';
        ctx.globalAlpha = 0.2;
        ctx.fillStyle = '#1a0b2e';
        ctx.fillRect(0,0,metrics.w, metrics.h);
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;

        // å¯©æŸ¥é‡é» 5: ç¹ªè£½æ¸…æ™°çš„è»Œé“åˆ†éš”ç·š
        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i=1; i<4; i++) {
            ctx.moveTo(i*metrics.laneW, 0);
            ctx.lineTo(i*metrics.laneW, metrics.h);
        }
        ctx.stroke();

        // ç§»é™¤åº•éƒ¨çš„åˆ¤å®šç·šç¹ªè£½

        // ç¹ªè£½éŸ³ç¬¦
        notes.forEach(n => {
            if (n.hit) return;
            // éœ“è™¹æ–¹å¡Š
            ctx.shadowBlur = 25; ctx.shadowColor = n.color;
            ctx.fillStyle = n.color;
            const pad = 6; // é‚Šè·åŠ å¤§ï¼Œè®“æ–¹å¡Šåˆ†é›¢æ„Ÿæ›´å¼·
            const w = metrics.laneW - pad*2;
            const h = metrics.noteH;
            
            // ç¹ªè£½ä¸»é«”
            ctx.beginPath();
            ctx.roundRect(n.lane * metrics.laneW + pad, n.y, w, h, 8); // åœ“è§’çŸ©å½¢
            ctx.fill();

            // ç¹ªè£½å…§éƒ¨é«˜å…‰ç´‹ç†
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.roundRect(n.lane * metrics.laneW + pad + 5, n.y + 5, w - 10, h*0.3, 4);
            ctx.fill();
        });

        // ç¹ªè£½ç²’å­
        particles.forEach(p => { p.draw(ctx); });

        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
