<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æ¥µé™è²ªé£Ÿè›‡ Pro (ç²¾ç´°ç‰ˆ)</title>
  <style>
    :root { --bg: #0b1220; --accent: #4cc9f0; --grid: rgba(60, 80, 120, 0.2); }
    body {
      margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      background: radial-gradient(circle at center, #152853 0%, var(--bg) 90%);
      font-family: system-ui, -apple-system, sans-serif; color: #fff; overflow: hidden; touch-action: none; user-select: none;
    }
    
    /* é ‚éƒ¨å°èˆªåˆ— */
    header {
      width: 100%; padding: 10px 20px; box-sizing: border-box;
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0; z-index: 20;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .home-btn {
        text-decoration: none; font-size: 18px; color: #fff;
        background: rgba(255,255,255,0.1); width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
        transition: 0.2s;
    }
    .home-btn:active { background: var(--accent); color: #000; }
    .score-box { font-size: 20px; font-weight: 800; color: var(--accent); font-family: monospace; }

    /* éŠæˆ²ä¸»é«”å®¹å™¨ */
    .main-area {
        flex-grow: 1; width: 100%; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; position: relative;
    }

    /* ç•«å¸ƒå¤–æ¡† */
    .game-container { 
        position: relative; 
        border-radius: 12px; overflow: hidden; 
        box-shadow: 0 0 40px rgba(76, 201, 240, 0.15);
        border: 2px solid rgba(255,255,255,0.1);
        background: #061022;
    }
    
    canvas {
      display: block;
      /* CSS ç¶²æ ¼èƒŒæ™¯ */
      background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: var(--cell) var(--cell);
    }

    #overlay {
      position: absolute; inset: 0; 
      background: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(4px); 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 10;
    }
    
    h2 { margin: 0 0 10px 0; font-size: 32px; text-shadow: 0 0 15px currentColor; color: #fff; }
    p { color: #ddd; font-size: 14px; margin-bottom: 25px; opacity: 0.8; }
    
    button#startBtn {
      padding: 12px 35px; font-size: 18px; font-weight: bold;
      background: var(--accent); border: none; border-radius: 50px;
      color: #000; cursor: pointer; box-shadow: 0 0 20px var(--accent);
      transition: transform 0.1s;
    }
    button#startBtn:active { transform: scale(0.95); }

    /* åº•éƒ¨æ§åˆ¶å™¨ */
    .d-pad {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
      width: 160px; margin-bottom: 30px; flex-shrink: 0;
    }
    .d-btn {
      aspect-ratio: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 24px; cursor: pointer;
      backdrop-filter: blur(5px);
    }
    .d-btn:active { background: rgba(76, 201, 240, 0.5); border-color: var(--accent); transform: scale(0.9); }
    
    @media (min-width: 800px) { .d-pad { display: none; } }
  </style>
</head>
<body>

  <header>
    <div class="header-left">
        <a href="#" class="home-btn">ğŸ </a>
        <div style="font-weight:900; letter-spacing:1px; margin-left:10px;">SNAKE <span style="color:var(--accent)">PRO</span></div>
    </div>
    <div class="score-box">SCORE: <span id="scoreVal">0</span></div>
  </header>

  <div class="main-area">
      <div class="game-container" id="gContainer">
        <canvas id="snakeCanvas"></canvas>
        <div id="overlay">
          <h2 id="m-title">READY?</h2>
          <p>æ»‘å‹•è¢å¹•æˆ–æŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹</p>
          <button id="startBtn">START GAME</button>
        </div>
      </div>
  </div>

  <div class="d-pad">
    <div style="grid-column:2"><div class="d-btn" id="c-up">â–²</div></div>
    <div style="grid-column:1"><div class="d-btn" id="c-left">â—€</div></div>
    <div style="grid-column:2"><div class="d-btn" id="c-down">â–¼</div></div>
    <div style="grid-column:3"><div class="d-btn" id="c-right">â–¶</div></div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('snakeCanvas');
  const ctx = canvas.getContext('2d');
  const container = document.getElementById('gContainer');
  const scoreEl = document.getElementById('scoreVal');
  const overlay = document.getElementById('overlay');
  
  let audioCtx;
  // ä¿®æ”¹ï¼šå°‡æ ¼å­æ•¸å¾ 20 å¢åŠ åˆ° 40ï¼Œè®“è›‡çœ‹èµ·ä¾†æ›´ç´°ç·»
  const GRID_SIZE = 40; 
  let cols = GRID_SIZE, rows = GRID_SIZE, cell, dpr;
  
  let snake = [], food = {};
  let dir = {x:0, y:-1}; // ç•¶å‰å¯¦éš›ç§»å‹•æ–¹å‘
  let inputQueue = [];   // ä¿®æ”¹ï¼šä½¿ç”¨éšŠåˆ—ä¾†ç·©å­˜æŒ‰éµï¼Œè§£æ±ºã€Œå¿«é€Ÿè‡ªæ®ºã€bug
  let score = 0, isRunning = false;
  let loopId = null;     // ç”¨æ–¼å–æ¶ˆ setTimeout

  // éŸ³æ•ˆ
  function playNote(f, type='sine', d=0.1) {
    if(!audioCtx || audioCtx.state !== 'running') return;
    try {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.08, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    } catch(e){}
  }

  // ç•«é¢é©é…
  function setupGrid() {
    dpr = window.devicePixelRatio || 1;
    // é›»è…¦ç‰ˆæœ€å¤§é™åˆ¶ç¨å¾®æ”¾å¯¬
    const maxW = Math.min(window.innerWidth * 0.95, 600);
    const maxH = window.innerHeight * 0.65;
    const size = Math.min(maxW, maxH);
    
    // ç¢ºä¿å¤§å°æ˜¯å¶æ•¸ä»¥é˜²æ¨¡ç³Š
    const finalSize = Math.floor(size / 2) * 2;

    container.style.width = finalSize + "px";
    container.style.height = finalSize + "px";
    
    cell = finalSize / cols;
    canvas.width = finalSize * dpr;
    canvas.height = finalSize * dpr;
    ctx.scale(dpr, dpr);
    
    document.documentElement.style.setProperty('--cell', cell + 'px');
    
    if(!isRunning && snake.length > 0) draw(); 
  }
  window.addEventListener('resize', setupGrid);

  function spawnFood() {
    let valid = false;
    while(!valid) {
        food = { 
            x: Math.floor(Math.random()*cols), 
            y: Math.floor(Math.random()*rows), 
            type: Math.random()<0.1?'star':(Math.random()<0.2?'pill':'normal') 
        };
        // ç¢ºä¿é£Ÿç‰©ä¸ç”Ÿæˆåœ¨è›‡èº«ä¸Š
        valid = !snake.some(p => p.x === food.x && p.y === food.y);
    }
  }

  function reset() {
    score = 0; scoreEl.textContent = score;
    const mid = Math.floor(cols/2);
    // åˆå§‹è›‡é•·åº¦è¨­ç‚º 5ï¼Œå› ç‚ºæ ¼å­è®Šå°äº†ï¼Œé•·ä¸€é»æ¯”è¼ƒå¥½å°æº–
    snake = [];
    for(let i=0; i<5; i++) snake.push({x:mid, y:mid+i});
    
    dir = {x:0, y:-1}; 
    inputQueue = []; // æ¸…ç©ºæŒ‡ä»¤
    spawnFood();
    isRunning = false;
    if(loopId) clearTimeout(loopId);
    
    overlay.style.display = 'flex';
    document.getElementById('m-title').innerText = "READY?";
    
    draw();
  }

  function step() {
    if(!isRunning) return;

    // 1. å¾éšŠåˆ—ä¸­å–å‡ºä¸‹ä¸€å€‹æœ‰æ•ˆçš„æ–¹å‘æŒ‡ä»¤
    // è§£æ±ºæ‰‹é€Ÿéå¿«å°è‡´è›‡é ­ 180 åº¦è¿´è½‰è‡ªæ®ºçš„ Bug
    if(inputQueue.length > 0) {
        const next = inputQueue.shift();
        // å†æ¬¡æª¢æŸ¥ï¼šé›–ç„¶è¼¸å…¥æ™‚æª¢æŸ¥éï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹
        if(next.x !== -dir.x && next.y !== -dir.y) {
            dir = next;
        }
    }

    const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
    
    // ç¢°æ’æª¢æ¸¬
    if(head.x<0 || head.x>=cols || head.y<0 || head.y>=rows || snake.some(p=>p.x===head.x && p.y===head.y)) {
      playNote(100, 'sawtooth', 0.5); 
      isRunning = false;
      document.getElementById('m-title').innerText = "GAME OVER";
      overlay.style.display = 'flex';
      return;
    }

    snake.unshift(head);
    
    if(head.x===food.x && head.y===food.y) {
      if(food.type==='star') { score+=30; playNote(800, 'square'); }
      else if(food.type==='pill') { 
          score+=5; playNote(400, 'sine'); 
          // ä¿®æ”¹ï¼šç¸®çŸ­æ©Ÿåˆ¶å¢åŠ ä¿è­·ï¼Œæœ€å°‘ä¿ç•™ 3 æ ¼
          if(snake.length > 4) { snake.pop(); snake.pop(); }
          else snake.pop(); // å¤ªçŸ­å°±åªç§»é™¤å°¾å·´(ä¸å¢é•·)
      }
      else { score+=10; playNote(600, 'triangle'); }
      
      scoreEl.textContent = score; 
      spawnFood();
    } else {
      snake.pop();
    }

    // ç¹ªè£½
    draw();
    
    // é€Ÿåº¦è¨ˆç®—ï¼šæ ¼å­è®Šå¤šäº†ï¼ŒåŸºç¤é€Ÿåº¦è¦åŠ å¿«ä¸€é» (å¾ 100ms é–‹å§‹)
    // é›£åº¦æ›²ç·šå¹³æ»‘åŒ–
    const speed = Math.max(40, 90 - Math.sqrt(score) * 4);
    loopId = setTimeout(step, speed);
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width/dpr, canvas.height/dpr);
    
    // ç•«é£Ÿç‰©
    const fx=food.x*cell, fy=food.y*cell;
    // è®“é£Ÿç‰©ç¨å¾®ç¸®å°ä¸€é»é»ï¼Œçœ‹èµ·ä¾†æ›´ç²¾ç·»
    const p=cell*0.15, s=cell-p*2;
    
    ctx.fillStyle = food.type==='star'?'#ffcf33':(food.type==='pill'?'#4cc9f0':'#ff4d6d');
    ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
    
    ctx.beginPath(); 
    if(food.type === 'star') {
        // ç°¡å–®ç•«åœ“å½¢ä»£è¡¨æ˜Ÿæ˜Ÿ/ç‰¹æ®Šç‰©ï¼Œå€åˆ¥åº¦æ›´é«˜
        ctx.arc(fx+cell/2, fy+cell/2, s/2, 0, Math.PI*2);
    } else {
        ctx.roundRect(fx+p, fy+p, s, s, 4); 
    }
    ctx.fill();
    ctx.shadowBlur = 0;

    // ç•«è›‡
    snake.forEach((p, i) => {
      // æ¼¸å±¤è‰²è›‡èº«
      ctx.fillStyle = i===0 ? '#fff' : (i%2===0 ? '#7CFF6B' : '#5CE64A');
      const x=p.x*cell, y=p.y*cell;
      
      // è®“è›‡èº«ä¹‹é–“æœ‰ä¸€é»é»ç¸«éš™ï¼Œçœ‹èµ·ä¾†æ˜¯ä¸€ç¯€ä¸€ç¯€çš„
      const gap = 0.5;
      ctx.beginPath(); 
      ctx.roundRect(x+gap, y+gap, cell-gap*2, cell-gap*2, i===0?4:2); 
      ctx.fill();
      
      // è›‡çœ¼
      if(i===0) { 
        ctx.fillStyle='#000';
        const eyeOff = cell*0.25;
        const eyeSize = cell*0.12;
        const cx = x + cell/2, cy = y + cell/2;
        ctx.beginPath(); 
        ctx.arc(cx + dir.y*eyeOff + dir.x*eyeOff, cy + dir.x*eyeOff + dir.y*eyeOff, eyeSize, 0, Math.PI*2); 
        ctx.arc(cx - dir.y*eyeOff + dir.x*eyeOff, cy - dir.x*eyeOff + dir.y*eyeOff, eyeSize, 0, Math.PI*2);
        ctx.fill();
      }
    });
  }

  const handleInput = (x, y) => { 
    if(!isRunning) return;
    
    // ç²å–é æœŸæœ€å¾Œçš„æ–¹å‘ (å¦‚æœæœ‰ç·©å­˜æŒ‡ä»¤ï¼Œå°±ä»¥ç·©å­˜çš„æœ€å¾Œä¸€å€‹ç‚ºæº–)
    const lastPendingDir = inputQueue.length > 0 ? inputQueue[inputQueue.length-1] : dir;
    
    // é˜²æ­¢åå‘ (ä¾‹å¦‚æ­£åœ¨å¾€å³ï¼Œä¸èƒ½æŒ‰å·¦)
    if(x !== -lastPendingDir.x && y !== -lastPendingDir.y) {
        // é˜²æ­¢é‡è¤‡è¼¸å…¥ç›¸åŒæ–¹å‘
        if(x !== lastPendingDir.x || y !== lastPendingDir.y) {
             // é™åˆ¶ç·©è¡å€å¤§å°ï¼Œé¿å…æŒ‰å¤ªå¿«ç©ç´¯å¤ªå¤šæ“ä½œ
            if(inputQueue.length < 3) inputQueue.push({x, y});
        }
    }
  };
  
  // æŒ‰éˆ•ç¶å®š
  document.getElementById('c-up').onclick = () => handleInput(0,-1);
  document.getElementById('c-down').onclick = () => handleInput(0,1);
  document.getElementById('c-left').onclick = () => handleInput(-1,0);
  document.getElementById('c-right').onclick = () => handleInput(1,0);
  
  // éµç›¤ç¶å®š
  window.addEventListener('keydown', e => {
      if(['ArrowUp','w','W'].includes(e.key)) handleInput(0,-1);
      if(['ArrowDown','s','S'].includes(e.key)) handleInput(0,1);
      if(['ArrowLeft','a','A'].includes(e.key)) handleInput(-1,0);
      if(['ArrowRight','d','D'].includes(e.key)) handleInput(1,0);
      if(e.code==='Space' && !isRunning) document.getElementById('startBtn').click();
  });

  // æ»‘å‹•æ“ä½œ
  let sx=0, sy=0;
  canvas.addEventListener('touchstart', e => { sx=e.touches[0].clientX; sy=e.touches[0].clientY; }, {passive:false});
  canvas.addEventListener('touchend', e => {
    const dx=e.changedTouches[0].clientX-sx, dy=e.changedTouches[0].clientY-sy;
    if(Math.abs(dx) > Math.abs(dy)) { 
        if(Math.abs(dx)>30) handleInput(dx>0?1:-1, 0); 
    } else { 
        if(Math.abs(dy)>30) handleInput(0, dy>0?1:-1); 
    }
  });

  document.getElementById('startBtn').onclick = () => {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
    overlay.style.display = 'none';
    if(!isRunning) {
        isRunning = true; 
        step();
    } else {
        // é‡ä¾†
        reset();
        isRunning = true;
        step();
    }
  };

  setupGrid();
  reset();
})();
</script>
</body>
</html>
