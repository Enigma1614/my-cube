<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>極限貪食蛇 Pro：Retina 旗艦版</title>
  <style>
    :root {
      --bg: #0b1220;
      --accent: #4cc9f0;
      --grid-color: rgba(23, 36, 71, 0.8);
      --cell-px: 25px; /* JS 會動態計算此值 */
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: radial-gradient(circle at center, #152853 0%, var(--bg) 70%);
      font-family: system-ui, -apple-system, sans-serif; color: #fff; overflow: hidden; touch-action: none;
    }
    .game-container { width: min(500px, 95vw); position: relative; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 15px; background: rgba(255, 255, 255, 0.05);
      border-radius: 12px 12px 0 0; border: 1px solid rgba(255,255,255,0.1); border-bottom: none;
    }
    .score-box { font-size: 20px; font-weight: 800; color: var(--accent); }
    
    canvas {
      width: 100%; height: auto; display: block;
      background-color: #061022;
      /* 精確背景網格渲染 */
      background-image: 
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: var(--cell-px) var(--cell-px);
      border: 1px solid rgba(255,255,255,0.1);
      image-rendering: -webkit-optimize-contrast;
    }

    #overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.75);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 10; backdrop-filter: blur(4px); border-radius: 0 0 12px 12px;
    }
    .msg-card { text-align: center; padding: 20px; }
    button#startBtn {
      padding: 15px 35px; font-size: 20px; font-weight: bold;
      background: var(--accent); border: none; border-radius: 50px;
      color: #000; cursor: pointer; box-shadow: 0 0 20px var(--accent);
    }

    /* 響應式控制器 */
    .d-pad {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
      width: 180px; margin: 20px auto 0;
    }
    .d-btn {
      aspect-ratio: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 20px; cursor: pointer;
    }
    @media (min-width: 800px) { .d-pad { display: none; } }
  </style>
</head>
<body>

  <div class="game-container">
    <header>
      <div style="font-weight:900; letter-spacing:1px;">SNAKE <span style="color:var(--accent)">PRO</span></div>
      <div class="score-box">SCORE: <span id="scoreVal">0</span></div>
    </header>

    <div style="position:relative; overflow:hidden; border-radius:0 0 12px 12px;">
      <canvas id="snakeCanvas"></canvas>
      <div id="overlay">
        <div class="msg-card">
          <h2 id="m-title" style="margin-top:0">READY?</h2>
          <p id="m-desc" style="color:#aaa; font-size:14px">滑動螢幕或使用按鈕控制</p>
          <button id="startBtn">START</button>
        </div>
      </div>
    </div>

    <div class="d-pad">
      <div style="grid-column:2"><div class="d-btn" id="ctrl-up">▲</div></div>
      <div style="grid-column:1"><div class="d-btn" id="ctrl-left">◀</div></div>
      <div style="grid-column:2"><div class="d-btn" id="ctrl-down">▼</div></div>
      <div style="grid-column:3"><div class="d-btn" id="ctrl-right">▶</div></div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('snakeCanvas');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('scoreVal');
  const overlay = document.getElementById('overlay');
  
  let audioCtx, cols, rows, cell, dpr;
  let snake = [], food = {}, dir = {x:0, y:0}, nextDir = {x:0, y:0};
  let score = 0, isRunning = false, moveTimer;

  // --- 音效系統 ---
  function playNote(f, d=0.1) {
    if(!audioCtx || audioCtx.state !== 'running') return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = 'sine'; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + d);
  }

  // --- 初始化畫布與 Retina 適應 ---
  function setupGrid() {
    dpr = window.devicePixelRatio || 1;
    const containerW = document.querySelector('.game-container').offsetWidth;
    // 固定 20 格，根據寬度動態算格子大小
    cols = 20; rows = 20;
    cell = containerW / cols;
    
    // 設定畫布內部尺寸 (Retina)
    canvas.width = containerW * dpr;
    canvas.height = containerW * dpr; // 正方形
    ctx.scale(dpr, dpr);
    
    // 同步 CSS 背景格線
    document.documentElement.style.setProperty('--cell-px', cell + 'px');
  }

  window.addEventListener('resize', setupGrid);
  setupGrid();

  function spawnFood() {
    food = {
      x: Math.floor(Math.random() * cols),
      y: Math.floor(Math.random() * rows),
      type: Math.random() < 0.1 ? 'star' : (Math.random() < 0.15 ? 'pill' : 'normal')
    };
    // 避免食物長在蛇身上
    if(snake.some(p => p.x === food.x && p.y === food.y)) spawnFood();
  }

  function resetGame() {
    score = 0; scoreEl.textContent = score;
    const mid = Math.floor(cols/2);
    snake = [{x:mid-2, y:mid}, {x:mid-1, y:mid}, {x:mid, y:mid}];
    dir = {x:1, y:0}; nextDir = {x:1, y:0};
    spawnFood();
    isRunning = false;
    overlay.style.display = 'flex';
  }

  function gameStep() {
    if(!isRunning) return;
    dir = nextDir;
    const head = { x: snake[snake.length-1].x + dir.x, y: snake[snake.length-1].y + dir.y };

    // 碰撞檢查
    if(head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows || snake.some(p => p.x === head.x && p.y === head.y)) {
      playNote(150, 0.5);
      isRunning = false;
      document.getElementById('m-title').innerText = "GAME OVER";
      overlay.style.display = 'flex';
      return;
    }

    snake.push(head);

    // 吃到食物
    if(head.x === food.x && head.y === food.y) {
      if(food.type === 'star') { score += 30; playNote(800, 0.2); }
      else if(food.type === 'pill') { score += 5; playNote(400, 0.2); if(snake.length > 2) snake.shift(); snake.shift(); }
      else { score += 10; playNote(600, 0.1); }
      
      scoreEl.textContent = score;
      spawnFood();
    } else {
      snake.shift();
    }

    // 隨分數提高速度
    const speed = Math.max(60, 160 - (score / 5));
    setTimeout(gameStep, speed);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 畫食物
    const fx = food.x * cell, fy = food.y * cell, sz = cell - 4;
    ctx.shadowBlur = food.type === 'normal' ? 0 : 15;
    ctx.shadowColor = food.type === 'star' ? '#ffcf33' : '#4cc9f0';
    ctx.fillStyle = food.type === 'star' ? '#ffcf33' : (food.type === 'pill' ? '#4cc9f0' : '#ff4d6d');
    ctx.beginPath();
    ctx.roundRect(fx + 2, fy + 2, sz, sz, 8);
    ctx.fill();
    ctx.shadowBlur = 0;

    // 畫蛇
    snake.forEach((p, i) => {
      const isHead = i === snake.length - 1;
      ctx.fillStyle = isHead ? '#fff' : '#7CFF6B';
      const sx = p.x * cell, sy = p.y * cell;
      ctx.beginPath();
      ctx.roundRect(sx + 2, sy + 2, cell - 4, cell - 4, isHead ? 8 : 4);
      ctx.fill();

      if(isHead) {
        // 眼睛
        ctx.fillStyle = '#000';
        const ex = sx + cell/2 + dir.x * (cell/4), ey = sy + cell/2 + dir.y * (cell/4);
        ctx.beginPath(); ctx.arc(ex, ey, cell*0.12, 0, Math.PI*2); ctx.fill();
      }
    });

    requestAnimationFrame(draw);
  }

  // --- 控制邏輯 ---
  const handleInput = (x, y) => {
    if(!isRunning && overlay.style.display === 'none') return; 
    if(x !== -dir.x) nextDir = {x, y};
  };

  // 按鈕
  document.getElementById('ctrl-up').onclick = () => handleInput(0, -1);
  document.getElementById('ctrl-down').onclick = () => handleInput(0, 1);
  document.getElementById('ctrl-left').onclick = () => handleInput(-1, 0);
  document.getElementById('ctrl-right').onclick = () => handleInput(1, 0);

  // 滑動
  let touchStartX = 0, touchStartY = 0;
  canvas.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, {passive: true});
  canvas.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;
    if(Math.abs(dx) > Math.abs(dy)) {
      if(Math.abs(dx) > 30) handleInput(dx > 0 ? 1 : -1, 0);
    } else {
      if(Math.abs(dy) > 30) handleInput(0, dy > 0 ? 1 : -1);
    }
  }, {passive: true});

  // 鍵盤
  window.onkeydown = (e) => {
    if(e.code === 'ArrowUp' || e.key === 'w') handleInput(0, -1);
    if(e.code === 'ArrowDown' || e.key === 's') handleInput(0, 1);
    if(e.code === 'ArrowLeft' || e.key === 'a') handleInput(-1, 0);
    if(e.code === 'ArrowRight' || e.key === 'd') handleInput(1, 0);
    if(e.code === 'Space' && !isRunning) document.getElementById('startBtn').click();
  };

  document.getElementById('startBtn').onclick = () => {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
    overlay.style.display = 'none';
    resetGame();
    isRunning = true;
    gameStep();
  };

  resetGame();
  draw();
})();
</script>
</body>
</html>
