<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>è±ªè¯ç‰ˆè²ªé£Ÿè›‡ Snake Pro</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a30;
      --text:#e6eefc;
      --muted:#9fb2d6;
      --accent:#4cc9f0;
      --snake:#7CFF6B;
      --food:#ff4d6d;
      --grid:#172447;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --cell-size: 24px; /* å‹•æ…‹æ›´æ–° */
    }
    *{box-sizing:border-box;}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background: radial-gradient(1200px 600px at 20% 20%, #152853 0%, var(--bg) 55%, #070b14 100%);
      font-family: sans-serif; color:var(--text); touch-action: manipulation; 
    }
    .wrap{ width:min(900px, 92vw); display:grid; gap:14px; grid-template-columns: 1fr; align-items:start; padding-bottom: 20px; }
    
    header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:14px 16px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10); border-radius:14px;
      box-shadow: var(--shadow); backdrop-filter: blur(6px);
    }
    .header-left { display: flex; align-items: center; gap: 15px; }
    header h1{ margin:0; font-size:18px; display:flex; align-items:center; gap:10px; }
    
    .badge{ font-size:12px; color:#07111f; background:linear-gradient(90deg, var(--accent), #b8f2ff); padding:4px 8px; border-radius:999px; font-weight:700; }
    .stats{ display:flex; gap:15px; font-size:13px; color:var(--muted); }
    .stats b{ color:var(--text); font-weight:800; }
    
    .panel{ display:grid; grid-template-columns: 1fr 280px; gap:14px; }
    @media (max-width: 850px){ .panel{ grid-template-columns: 1fr; } }
    
    .game{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10); border-radius:14px;
      box-shadow: var(--shadow); padding:14px; display: flex; flex-direction: column; align-items: center;
    }
    canvas{
      width:100%; height:auto; display:block; border-radius:12px;
      /* ä¿®æ”¹ï¼šä½¿ç”¨è®Šæ•¸æ§åˆ¶ç¶²æ ¼å¤§å° */
      background: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px), #061022;
      background-size: var(--cell-size) var(--cell-size), var(--cell-size) var(--cell-size);
      border:1px solid rgba(255,255,255,.08);
    }
    
    .side{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:14px; display:grid; gap:12px; height: fit-content; }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    input[type="range"]{ width: 120px; accent-color: var(--accent); }
    .btns{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    button{ cursor:pointer; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700; transition: 0.2s; }
    button:hover{ background:rgba(255,255,255,.12); }
    .primary{ background: linear-gradient(90deg, rgba(76,201,240,.25), rgba(124,255,107,.18)); border-color: rgba(76,201,240,.35); }
    .hint{ font-size:12px; color:var(--muted); line-height:1.6; padding:10px 12px; border-radius:12px; background: rgba(0,0,0,.16); }

    .overlay{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index: 10; }
    .msg{ text-align:center; padding:20px; border-radius:14px; background: rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(10px); }
    .rel{ position:relative; width: 100%; }

    /* æ‰‹æ©Ÿæ§åˆ¶å™¨ */
    .d-pad { margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 200px; }
    @media (min-width: 851px) { .d-pad { display: none; } }
    .d-btn { aspect-ratio: 1; font-size: 24px; background: rgba(255,255,255,0.08); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-left">
        <a href="#" onclick="location.reload()" class="home-btn" style="text-decoration:none">ğŸ </a>
        <h1>è±ªè¯è²ªé£Ÿè›‡ <span class="badge">Snake Pro</span></h1>
      </div>
      <div class="stats">
        <div>å¾—åˆ†ï¼š<b id="score">0</b></div>
        <div>æœ€é«˜ï¼š<b id="best">0</b></div>
      </div>
    </header>

    <div class="panel">
      <section class="game">
        <div class="rel">
          <canvas id="c" width="600" height="600"></canvas>
          <div class="overlay" id="overlay">
            <div class="msg" id="msg">
              <h2>æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
              <p>æ–¹å‘éµæ§åˆ¶ï¼Œç©ºç™½éµé–‹å§‹</p>
            </div>
          </div>
        </div>
        <div class="d-pad">
          <div style="grid-column:2"><button class="d-btn" id="btnUp">â–²</button></div>
          <div style="grid-column:1"><button class="d-btn" id="btnLeft">â—€</button></div>
          <div style="grid-column:2"><button class="d-btn" id="btnDown">â–¼</button></div>
          <div style="grid-column:3"><button class="d-btn" id="btnRight">â–¶</button></div>
        </div>
      </section>

      <aside class="side">
        <div class="row"><label>åŸºæœ¬é€Ÿåº¦</label><div><input id="speed" type="range" min="5" max="20" value="10"><span id="speedVal">10</span></div></div>
        <div class="row"><label>æ ¼å­å¤§å°</label><div><input id="cell" type="range" min="15" max="40" value="25"><span id="cellVal">25</span></div></div>
        <div class="btns"><button class="primary" id="toggle">é–‹å§‹/æš«åœ</button><button id="restart">é‡æ–°é–‹å§‹</button></div>
        <div class="hint">
          ğŸ ç´…è˜‹æœï¼šåŸºæœ¬æˆé•·<br/>
          âœ¨ é‡‘è‰²æ˜Ÿï¼š3å€åˆ†æ•¸ (éš¨æ©Ÿ)<br/>
          ğŸ§ª è—è—¥ä¸¸ï¼šæ¸›é€Ÿ+ç¸®çŸ­ (éš¨æ©Ÿ)
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
  const elScore = document.getElementById('score'), elBest = document.getElementById('best'), overlay = document.getElementById('overlay'), msgBox = document.getElementById('msg');
  const speedSlider = document.getElementById('speed'), cellSlider = document.getElementById('cell'), speedVal = document.getElementById('speedVal'), cellVal = document.getElementById('cellVal');
  const btnToggle = document.getElementById('toggle'), btnRestart = document.getElementById('restart');
  
  // éŸ³æ•ˆç³»çµ±
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playNote(freq, type, duration, vol=0.1) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
  }

  const sounds = {
    eat: () => playNote(880, 'square', 0.1),
    special: () => { playNote(1320, 'triangle', 0.2); setTimeout(()=>playNote(1760, 'triangle', 0.2), 50); },
    dead: () => { playNote(220, 'sawtooth', 0.4); playNote(110, 'sawtooth', 0.8); }
  };

  const LS_KEY = 'snake_pro_best';
  let best = Number(localStorage.getItem(LS_KEY) || 0);
  elBest.textContent = best;

  let cell, cols, rows, speed, lastTime = 0, acc = 0, running = false, gameOver = false;
  let dir = {x:1, y:0}, nextDir = {x:1, y:0}, snake = [], food = null, score = 0, tempSlow = 0;

  function initParams() {
    cell = Number(cellSlider.value);
    cols = Math.floor(canvas.width / cell);
    rows = Math.floor(canvas.height / cell);
    cellVal.textContent = cell;
    // é‡è¦ï¼šæ›´æ–° CSS è®Šæ•¸è®“èƒŒæ™¯ç¶²æ ¼å°é½Š
    document.documentElement.style.setProperty('--cell-size', cell + 'px');
  }

  function reset() {
    score = 0; elScore.textContent = score; 
    dir = {x:1, y:0}; nextDir = {x:1, y:0};
    const sx = Math.floor(cols/2), sy = Math.floor(rows/2);
    snake = [{x:sx-2, y:sy}, {x:sx-1, y:sy}, {x:sx, y:sy}];
    spawnFood(); gameOver = false; running = false;
    showOverlay('SNAKE PRO', 'æŒ‰ä¸‹ ç©ºç™½éµ æˆ– é–‹å§‹æŒ‰éˆ•');
    draw();
  }

  function spawnFood() {
    const occupied = new Set(snake.map(p => `${p.x},${p.y}`));
    let x, y;
    do {
      x = Math.floor(Math.random() * cols);
      y = Math.floor(Math.random() * rows);
    } while (occupied.has(`${x},${y}`));

    const r = Math.random();
    let type = 'normal';
    if(r < 0.1) type = 'star'; // 10% é‡‘æ˜Ÿ
    else if(r < 0.2) type = 'pill'; // 10% è—è—¥ä¸¸

    food = { x, y, type };
  }

  function step() {
    if ((nextDir.x !== -dir.x) || (nextDir.y !== -dir.y)) dir = { ...nextDir };
    const head = snake[snake.length - 1];
    const nx = head.x + dir.x, ny = head.y + dir.y;

    // æ’ç‰†æˆ–æ’è‡ªå·±
    if (nx < 0 || nx >= cols || ny < 0 || ny >= rows || snake.some(p => p.x === nx && p.y === ny)) {
      sounds.dead();
      endGame();
      return;
    }

    const newHead = { x: nx, y: ny };
    snake.push(newHead);

    if (nx === food.x && ny === food.y) {
      // åƒåˆ°é£Ÿç‰©
      if (food.type === 'normal') {
        score += 10; sounds.eat();
      } else if (food.type === 'star') {
        score += 30; sounds.special();
      } else if (food.type === 'pill') {
        score += 5; sounds.special();
        tempSlow = 30; // æ¸›é€Ÿ 30 æ­¥
        if(snake.length > 3) snake.shift(); // é¡å¤–ç¸®çŸ­ä¸€ç¯€
      }

      elScore.textContent = score;
      if (score > best) {
        best = score; elBest.textContent = best;
        localStorage.setItem(LS_KEY, best);
      }
      spawnFood();
    } else {
      snake.shift();
    }
    if (tempSlow > 0) tempSlow--;
  }

  function endGame() {
    running = false; gameOver = true;
    showOverlay('GAME OVER', `å¾—åˆ†ï¼š${score}<br/>æŒ‰ R é‡æ–°é–‹å§‹`);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ç•«é£Ÿç‰©
    let foodColor = '#ff4d6d';
    if(food.type === 'star') foodColor = '#ffcf33';
    if(food.type === 'pill') foodColor = '#4cc9f0';
    drawCell(food.x, food.y, foodColor, food.type !== 'normal');

    // ç•«è›‡
    snake.forEach((p, i) => {
      const isHead = i === snake.length - 1;
      const t = i / (snake.length - 1);
      let col = `rgb(${124 + t*50}, ${255}, ${107 + t*50})`;
      if(tempSlow > 0) col = '#4cc9f0'; // æ¸›é€Ÿç‹€æ…‹è®Šè—è‰²
      drawCell(p.x, p.y, col, isHead);
      
      // ç•«çœ¼ç›
      if(isHead) {
        ctx.fillStyle = '#000';
        const eyeSize = cell * 0.15;
        const offset = cell * 0.25;
        // æ ¹æ“šæ–¹å‘å¾®èª¿çœ¼ç›ä½ç½®
        ctx.beginPath();
        ctx.arc(p.x*cell + cell/2 + dir.x*offset, p.y*cell + cell/2 + dir.y*offset, eyeSize, 0, Math.PI*2);
        ctx.fill();
      }
    });
  }

  function drawCell(x, y, color, glow) {
    const pad = cell * 0.1;
    const r = cell * 0.2;
    const size = cell - pad * 2;
    ctx.fillStyle = color;
    if(glow) {
      ctx.shadowBlur = 15; ctx.shadowColor = color;
    }
    // ä½¿ç”¨åŸç”Ÿ roundRect (ç¾ä»£ç€è¦½å™¨æ”¯æŒ)
    ctx.beginPath();
    ctx.roundRect(x * cell + pad, y * cell + pad, size, size, r);
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  function showOverlay(title, sub) {
    overlay.style.display = 'grid';
    msgBox.innerHTML = `<h2>${title}</h2><p>${sub}</p>`;
  }

  function loop(ts) {
    const dt = (ts - lastTime) / 1000 || 0;
    lastTime = ts;
    
    let currentSpeed = speed;
    if (tempSlow > 0) currentSpeed *= 0.6; // é“å…·æ¸›é€Ÿæ•ˆæœ

    if (running && !gameOver) {
      acc += dt;
      if (acc >= 1 / currentSpeed) {
        step();
        acc = 0;
      }
    }
    draw();
    requestAnimationFrame(loop);
  }

  // äº‹ä»¶ç¶å®š
  const setDir = (x, y) => {
    if(gameOver) return;
    if(!running) { running = true; overlay.style.display = 'none'; }
    if(x !== -dir.x) nextDir.x = x;
    if(y !== -dir.y) nextDir.y = y;
  };

  window.addEventListener('keydown', e => {
    if(e.code === 'Space') { e.preventDefault(); running = !running; overlay.style.display = running ? 'none' : 'grid'; if(!running) showOverlay('å·²æš«åœ', 'æŒ‰ä¸‹ç©ºç™½éµç¹¼çºŒ'); }
    if(e.key.toLowerCase() === 'r') reset();
    if(e.key === 'ArrowUp' || e.key === 'w') setDir(0, -1);
    if(e.key === 'ArrowDown' || e.key === 's') setDir(0, 1);
    if(e.key === 'ArrowLeft' || e.key === 'a') setDir(-1, 0);
    if(e.key === 'ArrowRight' || e.key === 'd') setDir(1, 0);
  });

  // æ§åˆ¶é¢æ¿
  speedSlider.oninput = () => { speed = Number(speedSlider.value); speedVal.textContent = speed; };
  cellSlider.oninput = () => { initParams(); reset(); };
  btnToggle.onclick = () => { running = !running; overlay.style.display = running ? 'none' : 'grid'; };
  btnRestart.onclick = reset;

  // æ‰‹æ©ŸæŒ‰éˆ•
  document.getElementById('btnUp').onclick = () => setDir(0, -1);
  document.getElementById('btnDown').onclick = () => setDir(0, 1);
  document.getElementById('btnLeft').onclick = () => setDir(-1, 0);
  document.getElementById('btnRight').onclick = () => setDir(1, 0);

  initParams();
  speed = Number(speedSlider.value);
  reset();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
