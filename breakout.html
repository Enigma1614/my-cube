<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥µé™çˆ†ç ´ 3.0ï¼šRetina æ——è‰¦ç‰ˆ</title>
    <style>
        body { background: #050510; color: white; margin: 0; overflow: hidden; touch-action: none; font-family: system-ui, -apple-system, sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        #header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); }
        .score-box { font-size: 24px; font-weight: 800; color: #f1c40f; text-shadow: 0 0 10px #f1c40f; }
        #powerup-status { position: absolute; bottom: 100px; width: 100%; text-align: center; font-size: 20px; color: #0f0; font-weight: bold; opacity: 0; transition: 0.3s; }
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(5px); }
        h1 { margin: 0; font-size: clamp(30px, 8vw, 48px); color: #ff0055; text-shadow: 0 0 20px red; }
        button { padding: 15px 40px; font-size: 22px; background: #00d2ff; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 20px; box-shadow: 0 0 20px #00d2ff; }
        .hint { color: #888; font-size: 12px; margin-top: 10px; }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div id="header">
            <div style="color:#4cc9f0; font-weight:bold;">BRICK BREAKER PRO</div>
            <div class="score-box">SCORE: <span id="scoreVal">0</span></div>
        </div>
        <div id="powerup-status"></div>
    </div>
    <div id="overlay">
        <h1 id="m-title">æ¥µé™çˆ†ç ´ 3.0</h1>
        <p id="m-desc">æ¯æ¬¡ç”Ÿæˆ 3 æ’ç£šå¡Šï¼åˆ¥è®“å®ƒå€‘åˆ°åº•éƒ¨</p>
        <button id="startBtn">ğŸš€ å•Ÿå‹•éŠæˆ²</button>
        <div class="hint">æ”¯æ´è§¸æ§æ»‘å‹•èˆ‡æ»‘é¼ æ“ä½œ</div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let canvasW, canvasH, dpr, isPlaying = false;
    let score = 0, hitCount = 0, speedMult = 1, shake = 0;
    let bricks = [], balls = [], paddle = { x: 0, w: 100, h: 15 };
    let powerups = { long: 0, fireball: 0, shield: 0, fast: 0 };

    // --- éŸ³è¨Šå¼•æ“ ---
    let audioCtx;
    function playSfx(f, type='triangle', d=0.1, v=0.1) {
        if(!audioCtx || audioCtx.state !== 'running') return;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(v, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    // --- é«˜ç•«è³ªé©æ‡‰ ---
    function setupCanvas() {
        dpr = window.devicePixelRatio || 1;
        canvasW = window.innerWidth; canvasH = window.innerHeight;
        canvas.width = canvasW * dpr; canvas.height = canvasH * dpr;
        ctx.scale(dpr, dpr);
        paddle.w = canvasW * 0.25;
        paddle.x = (canvasW - paddle.w) / 2;
    }
    window.addEventListener('resize', setupCanvas);
    setupCanvas();

    function spawnThreeRows() {
        shake = 8;
        playSfx(150, 'sawtooth', 0.3, 0.05);
        for(let i=0; i<3; i++) {
            setTimeout(() => {
                bricks.forEach(b => { b.row++; b.targetY = b.row * 35 + 80; });
                for(let c=0; c<6; c++) {
                    let r = Math.random(), type = 'NORMAL', color = `hsl(${Math.random()*360}, 60%, 50%)`, hits = 1;
                    if (r < 0.1) { type = 'BOSS'; color = '#FFD700'; hits = 3; }
                    else if (r < 0.15) { type = 'BOMB'; color = '#ff0055'; }
                    else if (r < 0.2) { type = 'LONG'; color = '#00ff00'; }
                    else if (r < 0.25) { type = 'FIREBALL'; color = '#ffaa00'; }
                    else if (r < 0.3) { type = 'SHIELD'; color = '#00d2ff'; }
                    else if (r < 0.35) { type = 'SPEED'; color = '#cc00ff'; }
                    bricks.push({ x: c*(canvasW/6)+5, y: -40, targetY: 80, row: 0, col: c, status: 1, type, color, hits });
                }
            }, i * 120);
        }
    }

    function update() {
        if(!isPlaying) return;
        if(shake > 0) shake *= 0.9;
        speedMult = (Date.now() < powerups.fast) ? 1.7 : 1.1;
        let tw = (Date.now() < powerups.long) ? canvasW * 0.45 : canvasW * 0.25;
        paddle.w += (tw - paddle.w) * 0.1;

        bricks.forEach(b => {
            b.y += (b.targetY - b.y) * 0.1;
            if(b.status === 1 && b.y > canvasH - 100) endGame("åŸå¸‚æ·ªé™·ï¼", "ç£šå¡Šåˆ°é”åº•ç·š");
        });

        balls.forEach(ball => {
            if(!ball.active) return;
            ball.x += ball.dx * speedMult; ball.y += ball.dy * speedMult;
            if(ball.x < 10 || ball.x > canvasW - 10) { ball.dx *= -1; playSfx(400); }
            if(ball.y < 10) { ball.dy *= -1; playSfx(400); }
            if(ball.y > canvasH - 65 && ball.y < canvasH - 45 && ball.dy > 0) {
                if(ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
                    ball.dy *= -1; playSfx(600);
                    ball.dx = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2) * 6;
                }
            }
            if(Date.now() < powerups.shield && ball.y > canvasH - 20) { ball.dy *= -1; playSfx(500); }
            if(ball.y > canvasH + 20) ball.active = false;

            bricks.forEach(b => {
                if(b.status === 1 && ball.x > b.x && ball.x < b.x + (canvasW/6)-10 && ball.y > b.y && ball.y < b.y + 25) {
                    if(!(Date.now() < powerups.fireball)) ball.dy *= -1;
                    b.hits--;
                    if(b.hits <= 0) {
                        b.status = 0; score += (b.type === 'BOSS' ? 50 : 10);
                        playSfx(b.type === 'BOSS' ? 200 : 800, 'square');
                        if(b.type !== 'NORMAL' && b.type !== 'BOMB' && b.type !== 'BOSS') {
                            const el = document.getElementById('powerup-status');
                            el.innerText = b.type + " æ¨¡å¼ï¼"; el.style.opacity = 1;
                            powerups[b.type.toLowerCase()] = Date.now() + 10000;
                            setTimeout(()=>el.style.opacity=0, 2000);
                        }
                        hitCount++;
                        if(hitCount % 10 === 0) spawnThreeRows();
                    } else { playSfx(300, 'square'); }
                }
            });
        });
        if(balls.filter(b=>b.active).length === 0) endGame("GAME OVER", "çƒæ‰å…‰äº†");
    }

    function draw() {
        ctx.save();
        if(shake > 1) ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
        ctx.fillStyle = '#050510'; ctx.fillRect(0,0,canvasW,canvasH);
        if(Date.now() < powerups.shield) { ctx.fillStyle = '#00d2ff33'; ctx.fillRect(0, canvasH-15, canvasW, 15); }
        bricks.forEach(b => {
            if(b.status !== 1) return;
            ctx.fillStyle = b.color;
            ctx.beginPath(); ctx.roundRect(b.x, b.y, (canvasW/6)-10, 25, 6); ctx.fill();
            if(b.type !== 'NORMAL') { ctx.fillStyle = "#fff"; ctx.font = "bold 12px Arial"; ctx.fillText(b.type === 'BOSS' ? b.hits : 'â˜…', b.x + 10, b.y + 18); }
        });
        ctx.fillStyle = (Date.now() < powerups.long) ? '#0f0' : '#00d2ff';
        ctx.beginPath(); ctx.roundRect(paddle.x, canvasH-60, paddle.w, paddle.h, 10); ctx.fill();
        balls.forEach(ball => {
            if(!ball.active) return;
            ctx.fillStyle = (Date.now() < powerups.fireball) ? '#f00' : '#fff';
            ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2); ctx.fill();
        });
        ctx.restore();
        document.getElementById('scoreVal').innerText = score;
        if(isPlaying) requestAnimationFrame(draw);
    }

    function endGame(t, d) {
        isPlaying = false;
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('m-title').innerText = t;
        document.getElementById('m-desc').innerText = d + " Score: " + score;
    }

    document.getElementById('startBtn').onclick = () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('overlay').style.display = 'none';
        score = 0; hitCount = 0; bricks = []; balls = [{ x: canvasW/2, y: canvasH-150, dx: 4, dy: -4, active: true }];
        isPlaying = true; spawnThreeRows(); draw();
        const loop = () => { if(isPlaying) { update(); setTimeout(loop, 16); } }; loop();
    };

    const move = (e) => { 
        let x = e.touches ? e.touches[0].clientX : e.clientX;
        paddle.x = x - paddle.w/2;
        if(paddle.x < 0) paddle.x = 0;
        if(paddle.x > canvasW - paddle.w) paddle.x = canvasW - paddle.w;
    };
    window.addEventListener('mousemove', move);
    window.addEventListener('touchmove', (e)=>{ e.preventDefault(); move(e); }, {passive:false});
</script>
</body>
</html>
