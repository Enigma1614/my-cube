<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥µé™è¸©åœ°é›·</title>
    <style>
        :root { --bg: #050510; --accent: #00d2ff; --cell-bg: #1a1a2e; --cell-hover: #262642; }
        body {
            background: var(--bg); color: white; margin: 0; 
            font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
            touch-action: manipulation;
        }

        /* === 1. ä¸Šæ–¹è³‡è¨Šå€ (ä¿®å¾©å›å¤§å»³æŒ‰éˆ•) === */
        header {
            width: 100%; padding: 10px 15px; box-sizing: border-box;
            background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; z-index: 10;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .home-btn {
            text-decoration: none; font-size: 18px; color: #fff;
            background: rgba(255,255,255,0.1); width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
        }
        .home-btn:active { background: var(--accent); color: #000; }

        .game-title { font-weight: 800; letter-spacing: 1px; color: #fff; }
        .mine-count { font-family: monospace; font-size: 20px; color: #f1c40f; font-weight: bold; }

        /* === 2. éŠæˆ²ä¸»é«” (ç½®ä¸­ã€å¯æ²å‹•) === */
        #game-wrapper {
            flex: 1; width: 100%;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }

        /* ç‹€æ…‹æ–‡å­— (å¤±æ•—/å‹åˆ©é¡¯ç¤ºæ–¼æ­¤) */
        #status-msg {
            font-size: 24px; font-weight: 900; color: #fff; 
            text-shadow: 0 0 10px var(--accent);
            margin-bottom: 10px; height: 30px; /* ä½”ä½é˜²æ­¢è·³å‹• */
        }

        #grid-container {
            overflow: auto; /* å…è¨±åœ°åœ–å¤ªå¤§æ™‚æ²å‹• */
            max-width: 100%; max-height: 70vh;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }

        #grid {
            display: grid; gap: 2px;
            background: #333;
            pointer-events: auto;
        }

        .cell {
            width: 35px; height: 35px;
            background: var(--cell-bg);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 20px; cursor: pointer;
            transition: background 0.1s;
        }
        
        .cell.closed:active { background: var(--cell-hover); }
        .cell.open { background: #0b0b15; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        
        /* çˆ†ç‚¸çš„åœ°é›· (ç•¶ä¸‹è¸©åˆ°çš„) */
        .cell.boom { background: #ff0055 !important; animation: shake 0.5s; border: 1px solid #fff; z-index: 2; }
        
        /* éŠæˆ²çµæŸé¡¯ç¤ºçš„æœªç™¼ç¾åœ°é›· */
        .cell.revealed-mine { background: #2a0a1a; opacity: 0.8; }
        
        /* æ¨™è¨˜æ­£ç¢ºçš„æ——å­ (ç¶ è‰²åº•) */
        .cell.correct-flag { background: #0a2a0a; border: 1px solid #0f0; }
        
        /* æ¨™è¨˜éŒ¯èª¤çš„æ——å­ (ç´…è‰²å‰å‰) */
        .cell.wrong-flag { background: #2a0a0a; color: red; }

        /* æ•¸å­—é¡è‰² */
        .c-1 { color: #4cc9f0; } .c-2 { color: #4eff4e; } .c-3 { color: #ff4d6d; }
        .c-4 { color: #9d4edd; } .c-5 { color: #ff9e00; } .c-6 { color: #00ffff; }
        .c-7 { color: #fff; } .c-8 { color: #777; }

        /* === 3. ä¸‹æ–¹æ§åˆ¶å€ === */
        footer {
            width: 100%; padding: 15px;
            background: rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            flex-shrink: 0; min-height: 80px;
        }

        /* é‡æ–°é–‹å§‹æŒ‰éˆ• */
        #restartBtn {
            padding: 12px 50px; font-size: 20px; font-weight: bold;
            background: var(--accent); border: none; border-radius: 50px;
            color: #000; cursor: pointer; box-shadow: 0 0 20px var(--accent);
            display: none; /* åˆå§‹éš±è— */
        }
        #restartBtn:active { transform: scale(0.95); }

        .hint { color: #666; font-size: 12px; margin-top: 5px; text-align: center; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <a href="index.html" class="home-btn">ğŸ </a>
            <div class="game-title">MINESWEEPER</div>
        </div>
        <div class="mine-count">ğŸ’£ <span id="mineCount">0</span></div>
    </header>

    <div id="game-wrapper">
        <div id="status-msg"></div>
        <div id="grid-container">
            <div id="grid"></div>
        </div>
    </div>

    <footer>
        <button id="restartBtn">é‡æ–°é–‹å§‹</button>
        <div class="hint">ğŸ–±ï¸ å·¦éµ:æŒ–é–‹ / å³éµ:æ’æ——<br>ğŸ“± çŸ­æŒ‰:æŒ–é–‹ / é•·æŒ‰:æ’æ——</div>
    </footer>

<script>
    const grid = document.getElementById('grid');
    const statusMsg = document.getElementById('status-msg');
    const mineCountEl = document.getElementById('mineCount');
    const restartBtn = document.getElementById('restartBtn');

    let ROWS = 12, COLS = 10, MINES = 15;
    let board = []; 
    let isGameOver = false;
    let flagsLeft = MINES;
    let audioCtx;

    function playTone(freq, type='sine', d=0.1) {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    function resizeGame() {
        const w = window.innerWidth;
        if(w < 600) { COLS = 10; ROWS = 14; MINES = 15; } 
        else { COLS = 18; ROWS = 12; MINES = 30; }
        initGame();
    }

    function initGame() {
        isGameOver = false;
        flagsLeft = MINES;
        statusMsg.innerText = ""; // æ¸…ç©ºç‹€æ…‹æ–‡å­—
        mineCountEl.innerText = flagsLeft;
        restartBtn.style.display = 'none';
        
        grid.style.gridTemplateColumns = `repeat(${COLS}, 35px)`;
        grid.innerHTML = '';
        board = [];

        for (let r = 0; r < ROWS; r++) {
            let row = [];
            for (let c = 0; c < COLS; c++) {
                const cell = document.createElement('div');
                cell.classList.add('cell', 'closed');
                cell.dataset.r = r; cell.dataset.c = c;
                attachEvents(cell, r, c);
                grid.appendChild(cell);
                
                row.push({
                    r, c, isMine: false, isOpen: false, isFlagged: false, count: 0, element: cell
                });
            }
            board.push(row);
        }

        let minesPlaced = 0;
        while(minesPlaced < MINES) {
            const rr = Math.floor(Math.random() * ROWS);
            const cc = Math.floor(Math.random() * COLS);
            if(!board[rr][cc].isMine) {
                board[rr][cc].isMine = true;
                minesPlaced++;
            }
        }

        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                if(!board[r][c].isMine) {
                    let count = 0;
                    for(let i=-1; i<=1; i++) {
                        for(let j=-1; j<=1; j++) {
                            const nr = r+i, nc = c+j;
                            if(nr>=0 && nr<ROWS && nc>=0 && nc<COLS && board[nr][nc].isMine) count++;
                        }
                    }
                    board[r][c].count = count;
                }
            }
        }
    }

    function attachEvents(cell, r, c) {
        let timer;
        let isLongPress = false;

        cell.addEventListener('touchstart', (e) => {
            if(isGameOver) return;
            isLongPress = false;
            timer = setTimeout(() => {
                isLongPress = true;
                playTone(300, 'square', 0.05);
                if(navigator.vibrate) navigator.vibrate(50);
                toggleFlag(r, c);
            }, 500); 
        }, {passive: false});

        cell.addEventListener('touchend', (e) => {
            if(isGameOver) return;
            clearTimeout(timer);
            if(!isLongPress) {
                e.preventDefault(); 
                reveal(r, c);
            }
        });

        cell.addEventListener('mousedown', (e) => {
            if(isGameOver) return;
            if(e.button === 0) reveal(r, c);
            else if(e.button === 2) toggleFlag(r, c);
        });

        cell.addEventListener('contextmenu', e => e.preventDefault());
    }

    function toggleFlag(r, c) {
        const cellData = board[r][c];
        if(cellData.isOpen) return;

        cellData.isFlagged = !cellData.isFlagged;
        cellData.element.innerText = cellData.isFlagged ? 'ğŸš©' : '';
        
        flagsLeft += cellData.isFlagged ? -1 : 1;
        mineCountEl.innerText = flagsLeft;
    }

    function reveal(r, c) {
        if(r < 0 || r >= ROWS || c < 0 || c >= COLS) return;
        const cellData = board[r][c];
        if(cellData.isOpen || cellData.isFlagged || isGameOver) return;

        cellData.isOpen = true;
        cellData.element.classList.remove('closed');
        cellData.element.classList.add('open');

        // è¸©åˆ°é›·ï¼šå¼•çˆ†
        if(cellData.isMine) {
            cellData.element.classList.add('boom');
            cellData.element.innerText = 'ğŸ’¥';
            gameOver(false);
            return;
        }

        playTone(600 + (Math.random()*200));

        if(cellData.count > 0) {
            cellData.element.innerText = cellData.count;
            cellData.element.classList.add(`c-${cellData.count}`);
        } else {
            for(let i=-1; i<=1; i++) {
                for(let j=-1; j<=1; j++) {
                    reveal(r+i, c+j);
                }
            }
        }
        checkWin();
    }

    function checkWin() {
        let closedCount = 0;
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                if(!board[r][c].isOpen) closedCount++;
            }
        }
        if(closedCount === MINES) gameOver(true);
    }

    function gameOver(win) {
        isGameOver = true;
        
        if(win) {
            statusMsg.innerText = "YOU WIN! ğŸ‰";
            statusMsg.style.color = "#00ff00";
            playTone(800, 'triangle', 0.5);
            // å‹åˆ©æ™‚è‡ªå‹•æ¨™è¨˜å‰©é¤˜åœ°é›·
            flagAllMines();
        } else {
            statusMsg.innerText = "GAME OVER";
            statusMsg.style.color = "#ff0055";
            playTone(150, 'sawtooth', 0.8);
            
            // å¤±æ•—æ™‚ï¼šå±•ç¤ºæ‰€æœ‰åœ°é›·ç‹€æ…‹
            revealMapState();
        }
        restartBtn.style.display = 'block';
    }

    // å‹åˆ©æ™‚æŠŠå‰©ä¸‹çš„é›·éƒ½æ’ä¸Šæ——å­
    function flagAllMines() {
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                if(board[r][c].isMine && !board[r][c].isFlagged) {
                    board[r][c].element.innerText = 'ğŸš©';
                    board[r][c].element.classList.add('correct-flag');
                }
            }
        }
    }

    // å¤±æ•—æ™‚å±•ç¤ºå…¨åœ–ç‹€æ…‹
    function revealMapState() {
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                const cell = board[r][c];
                
                // 1. æœ¬ä¾†æ˜¯é›·
                if (cell.isMine) {
                    if (cell.isOpen) {
                        // é€™æ˜¯å¼•çˆ†é»ï¼Œå·²ç¶“è™•ç†éäº† ('boom')
                        continue; 
                    }
                    
                    cell.element.classList.remove('closed');
                    
                    if (cell.isFlagged) {
                        // æ¨™å°äº†ï¼šé¡¯ç¤ºç¶ è‰²åº•çš„æ——å­
                        cell.element.innerText = 'ğŸš©';
                        cell.element.classList.add('correct-flag');
                    } else {
                        // æ²’ç™¼ç¾çš„é›·ï¼šé¡¯ç¤ºç‚¸å½ˆ
                        cell.element.innerText = 'ğŸ’£';
                        cell.element.classList.add('revealed-mine');
                    }
                } 
                // 2. æœ¬ä¾†ä¸æ˜¯é›·
                else {
                    if (cell.isFlagged) {
                        // æ¨™éŒ¯äº†ï¼šé¡¯ç¤ºç´…è‰²å‰å‰
                        cell.element.classList.remove('closed');
                        cell.element.innerText = 'âŒ';
                        cell.element.classList.add('wrong-flag');
                    }
                }
            }
        }
    }

    window.addEventListener('resize', () => {
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(resizeGame, 200);
    });
    
    restartBtn.onclick = initGame;
    resizeGame();

</script>
</body>
</html>
